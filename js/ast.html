<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>资料库</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <link rel="icon" href="/longweixia/favicon.ico">
    <meta name="description" content="10点读书">
    
    <link rel="preload" href="/longweixia/assets/css/0.styles.e7f35309.css" as="style"><link rel="preload" href="/longweixia/assets/js/app.30853e2a.js" as="script"><link rel="preload" href="/longweixia/assets/js/2.19b4ab8a.js" as="script"><link rel="preload" href="/longweixia/assets/js/38.77987057.js" as="script"><link rel="prefetch" href="/longweixia/assets/js/10.17389278.js"><link rel="prefetch" href="/longweixia/assets/js/11.13e843aa.js"><link rel="prefetch" href="/longweixia/assets/js/12.9ad5d840.js"><link rel="prefetch" href="/longweixia/assets/js/13.79fcf880.js"><link rel="prefetch" href="/longweixia/assets/js/14.c4361c82.js"><link rel="prefetch" href="/longweixia/assets/js/15.44426049.js"><link rel="prefetch" href="/longweixia/assets/js/16.581eff27.js"><link rel="prefetch" href="/longweixia/assets/js/17.d109ff42.js"><link rel="prefetch" href="/longweixia/assets/js/18.3ec7fcf3.js"><link rel="prefetch" href="/longweixia/assets/js/19.35fd21bb.js"><link rel="prefetch" href="/longweixia/assets/js/20.66a6e34b.js"><link rel="prefetch" href="/longweixia/assets/js/21.71051137.js"><link rel="prefetch" href="/longweixia/assets/js/22.9869167b.js"><link rel="prefetch" href="/longweixia/assets/js/23.2ca1aaba.js"><link rel="prefetch" href="/longweixia/assets/js/24.2232ffb7.js"><link rel="prefetch" href="/longweixia/assets/js/25.e0f0715a.js"><link rel="prefetch" href="/longweixia/assets/js/26.f5c106a0.js"><link rel="prefetch" href="/longweixia/assets/js/27.9e31faa4.js"><link rel="prefetch" href="/longweixia/assets/js/28.113fc19e.js"><link rel="prefetch" href="/longweixia/assets/js/29.bc167a67.js"><link rel="prefetch" href="/longweixia/assets/js/3.88b3d293.js"><link rel="prefetch" href="/longweixia/assets/js/30.03a76239.js"><link rel="prefetch" href="/longweixia/assets/js/31.c81c40f1.js"><link rel="prefetch" href="/longweixia/assets/js/32.bd90225a.js"><link rel="prefetch" href="/longweixia/assets/js/33.1d2874e8.js"><link rel="prefetch" href="/longweixia/assets/js/34.b5be839b.js"><link rel="prefetch" href="/longweixia/assets/js/35.346f3036.js"><link rel="prefetch" href="/longweixia/assets/js/36.81c5024f.js"><link rel="prefetch" href="/longweixia/assets/js/37.c67ed549.js"><link rel="prefetch" href="/longweixia/assets/js/39.9c901ab8.js"><link rel="prefetch" href="/longweixia/assets/js/4.793f9f6e.js"><link rel="prefetch" href="/longweixia/assets/js/40.3bf5737a.js"><link rel="prefetch" href="/longweixia/assets/js/41.10d00b34.js"><link rel="prefetch" href="/longweixia/assets/js/42.d1c1060a.js"><link rel="prefetch" href="/longweixia/assets/js/43.f8e83df1.js"><link rel="prefetch" href="/longweixia/assets/js/44.0da5d0cd.js"><link rel="prefetch" href="/longweixia/assets/js/45.94d21e4f.js"><link rel="prefetch" href="/longweixia/assets/js/46.9d1beff0.js"><link rel="prefetch" href="/longweixia/assets/js/47.adbb41c5.js"><link rel="prefetch" href="/longweixia/assets/js/48.905e25b7.js"><link rel="prefetch" href="/longweixia/assets/js/49.2763efa3.js"><link rel="prefetch" href="/longweixia/assets/js/5.e7ca5135.js"><link rel="prefetch" href="/longweixia/assets/js/50.ffe0192f.js"><link rel="prefetch" href="/longweixia/assets/js/51.b4a8bbd5.js"><link rel="prefetch" href="/longweixia/assets/js/52.3bf3d83c.js"><link rel="prefetch" href="/longweixia/assets/js/53.c938b0b0.js"><link rel="prefetch" href="/longweixia/assets/js/54.a12149e7.js"><link rel="prefetch" href="/longweixia/assets/js/55.2f8f4d12.js"><link rel="prefetch" href="/longweixia/assets/js/56.b040f922.js"><link rel="prefetch" href="/longweixia/assets/js/57.3565cde1.js"><link rel="prefetch" href="/longweixia/assets/js/58.ddccb3ba.js"><link rel="prefetch" href="/longweixia/assets/js/59.052024c3.js"><link rel="prefetch" href="/longweixia/assets/js/6.a797012b.js"><link rel="prefetch" href="/longweixia/assets/js/60.6ef28404.js"><link rel="prefetch" href="/longweixia/assets/js/61.512be1bf.js"><link rel="prefetch" href="/longweixia/assets/js/62.6e05c141.js"><link rel="prefetch" href="/longweixia/assets/js/63.ca304a0d.js"><link rel="prefetch" href="/longweixia/assets/js/64.6477c58d.js"><link rel="prefetch" href="/longweixia/assets/js/65.e0da78df.js"><link rel="prefetch" href="/longweixia/assets/js/66.e109c264.js"><link rel="prefetch" href="/longweixia/assets/js/67.e498d6df.js"><link rel="prefetch" href="/longweixia/assets/js/68.276ed907.js"><link rel="prefetch" href="/longweixia/assets/js/69.2bc6a533.js"><link rel="prefetch" href="/longweixia/assets/js/7.55c60d55.js"><link rel="prefetch" href="/longweixia/assets/js/70.bb6787af.js"><link rel="prefetch" href="/longweixia/assets/js/71.5ac32627.js"><link rel="prefetch" href="/longweixia/assets/js/72.ba9cb06b.js"><link rel="prefetch" href="/longweixia/assets/js/73.fe9c59de.js"><link rel="prefetch" href="/longweixia/assets/js/74.ecb3f57f.js"><link rel="prefetch" href="/longweixia/assets/js/75.0169e10d.js"><link rel="prefetch" href="/longweixia/assets/js/76.f804ad10.js"><link rel="prefetch" href="/longweixia/assets/js/77.49c57594.js"><link rel="prefetch" href="/longweixia/assets/js/78.a2f5ab6e.js"><link rel="prefetch" href="/longweixia/assets/js/79.acb9ebc0.js"><link rel="prefetch" href="/longweixia/assets/js/8.cce1d689.js"><link rel="prefetch" href="/longweixia/assets/js/80.8d936fe0.js"><link rel="prefetch" href="/longweixia/assets/js/81.0e3986b9.js"><link rel="prefetch" href="/longweixia/assets/js/82.774d6e22.js"><link rel="prefetch" href="/longweixia/assets/js/83.c0ddf8bb.js"><link rel="prefetch" href="/longweixia/assets/js/84.5a58253a.js"><link rel="prefetch" href="/longweixia/assets/js/85.20ba04b9.js"><link rel="prefetch" href="/longweixia/assets/js/9.023f9158.js">
    <link rel="stylesheet" href="/longweixia/assets/css/0.styles.e7f35309.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/longweixia/" class="home-link router-link-active"><!----> <span class="site-name">资料库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/longweixia/html/" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/longweixia/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/longweixia/js/" class="nav-link router-link-active">
  JS
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/longweixia/html/" class="nav-link">
  HTML
</a></div><div class="nav-item"><a href="/longweixia/css/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/longweixia/js/" class="nav-link router-link-active">
  JS
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/html/" class="sidebar-heading clickable"><span>1. HTML</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/css/" class="sidebar-heading clickable"><span>2. CSS</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/js/" class="sidebar-heading clickable router-link-active open"><span>3. JS</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/longweixia/js/JS/1.html" class="sidebar-link">基础1</a></li><li><a href="/longweixia/js/JS/2.html" class="sidebar-link">基础2</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>手写函数</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>正则</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/longweixia/js/ast.html" aria-current="page" class="active sidebar-link">ast</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_1-什么是ast" class="sidebar-link">1. 什么是AST</a></li><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_2-原理" class="sidebar-link">2. 原理</a></li><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_3-ast的用途" class="sidebar-link">3. AST的用途</a></li><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_4-ast使用3个流程" class="sidebar-link">4. AST使用3个流程</a></li><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_5-ast的结构" class="sidebar-link">5. AST的结构</a></li><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_6-ast编译过程" class="sidebar-link">6. AST编译过程</a></li><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_7-babel原理浅析" class="sidebar-link">7. babel原理浅析</a></li><li class="sidebar-sub-header"><a href="/longweixia/js/ast.html#_8-vue中ast抽象语法树的运用" class="sidebar-link">8. vue中AST抽象语法树的运用;</a></li></ul></li><li><a href="/longweixia/js/arry.html" class="sidebar-link">数组和对象</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/vue/" class="sidebar-heading clickable"><span>4. Vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/ts/" class="sidebar-heading clickable"><span>5. TS</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/node/" class="sidebar-heading clickable"><span>6. Node</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/business/" class="sidebar-heading clickable"><span>7. 业务</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/tools/" class="sidebar-heading clickable"><span>8. 工具</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/browser/" class="sidebar-heading clickable"><span>9. 浏览器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/vuePress/" class="sidebar-heading clickable"><span>10. vuePress</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/xcx/" class="sidebar-heading clickable"><span>11. 小程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/longweixia/note/" class="sidebar-heading clickable"><span>12. 总结</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>背景，原理，使用场景-用途，如何使用，优缺点，怎么优化，横向对比竞品，扩展引申相同原理的技术，或者更进一步，有更好的解决方案。</p></blockquote> <blockquote><p>STAR 点出问题，多种解决方法，为什么选这种，结果，还有更好的方法吗</p></blockquote> <h2 id="_1-什么是ast"><a href="#_1-什么是ast" class="header-anchor">#</a> 1. 什么是AST</h2> <p><code>抽象语法树</code>（abstract syntax code，AST）是<code>源代码</code>的抽象语法结构的<code>树状</code>表示，树上的每个<code>节点</code>都表示源代码中的一种<code>结构</code>。</p> <p>为什么说是抽象的，因为它把js代码进行了结构化的转化，转化为一种数据结构。</p> <p>这种数据结构其实就是一个大的<code>json</code>对象，json我们都熟悉，他就像一颗枝繁叶茂的树。有树根，有树干，有树枝，有树叶，无论多小多大，都是一棵完整的树。</p> <p>简单理解,就是把我们写的<code>代码</code>按<code>照一定的</code>规则<code>转换成一种</code>树形结构`。</p> <h2 id="_2-原理"><a href="#_2-原理" class="header-anchor">#</a> 2. 原理</h2> <p><a data-fancybox="" title="ast" href="/ast1.png"><img src="/ast1.png" alt="order"></a></p> <p>JavaScript 代码的编译和执行过程
从上图中我们可以看到,<code>JavaScript引擎</code>做的第一件事情就是把JavaScript代码<code>编译成抽象语法树</code></p> <h2 id="_3-ast的用途"><a href="#_3-ast的用途" class="header-anchor">#</a> 3. AST的用途</h2> <p>AST的作用不仅仅是用来在JavaScript引擎的编译上，我们在实际的开发过程中也是经常使用的:</p> <ul><li>比如我们常用的babel插件将 ES6转化成ES5</li> <li>使用 UglifyJS来压缩代码 、css预处理器、开发WebPack插件</li> <li>Vue-cli前端自动化工具等等，这些底层原理都是基于AST来实现的</li></ul> <p>AST能力十分强大， 能够帮助开发者理解JavaScript这门语言的精髓。</p> <h2 id="_4-ast使用3个流程"><a href="#_4-ast使用3个流程" class="header-anchor">#</a> 4. AST使用3个流程</h2> <p>我们都知道,在传统的编译语言的流程中,程序的一段源代码在执行之前会经历三个步骤,统称为&quot;编译&quot;:</p> <p><strong>(1)分词/词法分析</strong></p> <p>这个过程会将由字符组成的<code>字符串</code>分解成有意义的<code>代码块</code>,这些代码块统称为<code>词法单元(token)</code>.</p> <p>举个例子: <code>let a = 1</code>, 这段程序通常会被分解成为下面这些词法单元:</p> <ul><li>let 、a、=、1、 ；</li> <li>空格是否被当成词法单元，取决于空格在这门语言中的意义。</li></ul> <p><strong>(2)解析/语法分析</strong></p> <p>这个过程是将<code>词法单元流</code>转换成一个由<code>元素嵌套</code>所组成的代表了程序语法结构的<code>树</code>,这个树被称为&quot;抽象语法树&quot;（abstract syntax code，AST）</p> <p><strong>(3)代码生成</strong></p> <p>将AST转换成<code>可执行代码</code>的过程被称为代码生成.</p> <h2 id="_5-ast的结构"><a href="#_5-ast的结构" class="header-anchor">#</a> 5. AST的结构</h2> <p><strong>我们先来看一组简单的AST树状结构:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>const team = '大转转FE'
经过转化,输出如下AST树状结构:

{
  &quot;type&quot;: &quot;Program&quot;, //程序
  &quot;start&quot;: 0,
  &quot;end&quot;: 18,
  &quot;body&quot;: [
    {
      &quot;type&quot;: &quot;VariableDeclaration&quot;, //变量声明
      &quot;start&quot;: 0,
      &quot;end&quot;: 18,
      &quot;declarations&quot;: [ // 声明
        {
          &quot;type&quot;: &quot;VariableDeclarator&quot;, //变量声明器
          &quot;start&quot;: 6,
          &quot;end&quot;: 18,
          &quot;id&quot;: {
            &quot;type&quot;: &quot;Identifier&quot;, //标识符
            &quot;start&quot;: 6,
            &quot;end&quot;: 8,
            &quot;name&quot;: &quot;team&quot;
          },
          &quot;init&quot;: {
            &quot;type&quot;: &quot;Literal&quot;, //字面量
            &quot;start&quot;: 11,
            &quot;end&quot;: 18,
            &quot;value&quot;: &quot;大转转FE&quot;,
            &quot;raw&quot;: &quot;'大转转FE'&quot;
          }
        }
      ],
      &quot;kind&quot;: &quot;const&quot;
    }
  ],
  &quot;sourceType&quot;: &quot;module&quot;
}
</code></pre></div><p>我们可以看到，一个标准的AST结构可以理解为一个json对象，那我们就可以通过一些方法去解析和操作它，<a href="https://esprima.org/demo/parse.html#" target="_blank" rel="noopener noreferrer">这里我们先提供一个在线检测工具,大家可以自行去体验:<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_6-ast编译过程"><a href="#_6-ast编译过程" class="header-anchor">#</a> 6. AST编译过程</h2> <p><strong>AST编译流程图:</strong></p> <p><a data-fancybox="" title="ast" href="/ast2.png"><img src="/ast2.png" alt="order"></a></p> <p>我们可以看到,AST工具会源代码经过四个阶段的转换：</p> <p><strong>6-1. 词法分析scanner</strong></p> <div class="language- extra-class"><pre class="language-text"><code>var company = 'zhuanzhuan'
</code></pre></div><p>假如有以上代码，在词法分析阶段，会先对整个代码进行<code>扫描</code>，生成<code>tokens流</code>。</p> <p>扫描过程如下：</p> <ul><li><p>通过<code>条件判断语句</code>判断这个字符是 <code>字母</code>， <code>&quot;/&quot;</code>,  <code>&quot;数字&quot;</code> , <code>空格</code> , <code>&quot;(&quot; , &quot;)&quot;</code> , <code>&quot;;&quot;</code> 等等。</p></li> <li><p>如果是<code>字母</code>会继续<code>往下</code>看如果还是<code>字母</code>或者<code>数字</code>，会继续这一过程直到不是为止，这个时候发现找到的这个字符串是一个 <code>&quot;var&quot;</code>， 是一个<code>Keyword</code>，并且<code>下一个</code>字符是一个 <code>&quot;空格&quot;</code>， 就会生成<code>{ &quot;type&quot; : &quot;Keyword&quot; , &quot;value&quot; : &quot;var&quot; }</code>放入数组中。</p></li> <li><p>它继续<code>向下</code>找发现了一个字母 'company'(因为找到的上一个值是 &quot;var&quot; 这个时候如果它发现<code>下一个</code>字符<code>不是字母</code>可能直接就会<code>报错</code>返回)并且后面是空格，生成<code>{ &quot;type&quot; : &quot;Identifier&quot; , &quot;value&quot; : &quot;company&quot; }</code>放到数组中。</p></li> <li><p>发现了一个 <code>&quot;=&quot;</code>, 生成了<code>{ &quot;type&quot; :  &quot;Punctuator&quot; , &quot;value&quot; : &quot;=&quot; }</code>放到了数组中。</p></li> <li><p>发现了'zhuanzhuan',生成了{ &quot;type&quot; : &quot;String&quot; , &quot;value&quot; :  &quot;zhuanzhuan&quot; }放到了数组中。</p></li></ul> <p><strong>解析如下：</strong></p> <p><a data-fancybox="" title="ast" href="/ast3.png"><img src="/ast3.png" alt="order"></a></p> <p><strong>6-2.parser生成AST树</strong></p> <p>这里我们使用<code>esprima</code>去生成, 安装相关依赖 <code>npm i  esprima --save</code></p> <p>以如下代码为例:</p> <div class="language- extra-class"><pre class="language-text"><code>const company = 'zhuanzhuan'
</code></pre></div><p>要得到其对应的AST,我们对其进行如下操作:</p> <div class="language- extra-class"><pre class="language-text"><code>const esprima = require('esprima');
let code = 'const company = &quot;zhuanzhuan&quot; ';
const ast = esprima.parseScript(code);
console.log(ast);
</code></pre></div><p>运行结果如下:</p> <div class="language- extra-class"><pre class="language-text"><code>$ node test.js
Script {
  type: 'Program',
  body: [
    VariableDeclaration {
      type: 'VariableDeclaration',
      declarations: [Array],
      kind: 'const'
    }
  ],
  sourceType: 'script'
}
</code></pre></div><p>这样我们就得到了一棵AST树</p> <p><strong>6-3.traverse对AST树遍历,进行增删改查</strong></p> <p>这里我们使用<code>estraverse</code>去完成, 安装相关依赖  <code>npm i estraverse  --save</code></p> <p>还是上面的代码, 我们更改为 <code>const team =  '大转转FE'</code></p> <div class="language- extra-class"><pre class="language-text"><code>const esprima = require('esprima');
const estraverse = require('estraverse');
let code = 'const company = &quot;zhuanzhuan&quot; ';
const ast = esprima.parseScript(code);
estraverse.traverse(ast, {
     enter: function (node) {
     node.name = 'team';
        node.value = &quot;大转转FE&quot;;
    }
});
console.log(ast);
</code></pre></div><p>运行结果如下:</p> <div class="language- extra-class"><pre class="language-text"><code>$ node test.js
Script {
  type: 'Program',
  body: [
    VariableDeclaration {
      type: 'VariableDeclaration',
      declarations: [Array], //声明
      kind: 'const',
      name: 'team',
      value: '大转转FE'
    }
  ],
  sourceType: 'script',
  name: 'team',
  value: '大转转FE'
}
</code></pre></div><p>这样一来,我们就完成了对AST的遍历更新。</p> <p><strong>6-4.generator将更新后的AST转化成代码</strong>
这里我们使用<code>escodegen</code>去生成, 安装相关依赖 <code>npm i escodegen  --save</code></p> <p>整体代码结构如下:</p> <div class="language- extra-class"><pre class="language-text"><code>const esprima = require('esprima');
const estraverse = require('estraverse');
const escodegen = require('escodegen');
let code = 'const company = &quot;zhuanzhuan&quot; ';
const ast = esprima.parseScript(code);
estraverse.traverse(ast, {
    enter: function (node) {
     node.name = 'team';
        node.value = &quot;大转转FE&quot;;
    }
});
const transformCode = escodegen.generate(ast);
console.log(transformCode);
</code></pre></div><p>会得到如下结果:</p> <div class="language- extra-class"><pre class="language-text"><code>$ node test.js
const team = '大转转FE';

</code></pre></div><p>这样一来,我们就完成了对一段简单代码的AST编译过程。</p> <h2 id="_7-babel原理浅析"><a href="#_7-babel原理浅析" class="header-anchor">#</a> 7. babel原理浅析</h2> <p>Babel插件就是<code>作用于</code>抽象语法树。</p> <p><strong>Babel 的三个主要处理步骤分别是：</strong></p> <ul><li>解析（parse）</li> <li>转换（transform）</li> <li>生成（generate）。</li></ul> <p><strong>解析</strong></p> <p>将<code>代码</code>解析成<code>抽象语法树（AST）</code>，每个js引擎（比如Chrome浏览器中的V8引擎）都有自己的<code>AST解析器</code>，而Babel是通过<a href="https://github.com/babel/babylon" target="_blank" rel="noopener noreferrer">Babylon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>实现的。</p> <p>解析过程有两个阶段：</p> <ul><li>词法分析和语法分析，词法分析阶段把<code>字符串形式</code>的代码转换为<code>令牌（tokens）流</code>，令牌类似于AST中节点；</li> <li>法分析阶段则会把一个<code>令牌流</code>转换成 <code>AST</code>的形式，同时这个阶段会把令牌中的信息转换成AST的表述结构。</li></ul> <p><strong>转换</strong></p> <p>转换步骤<code>接收AST</code> 并对其进行<code>遍历</code>，在此过程中对<code>节点</code>进行<code>添加</code>、<code>更新</code>及<code>移除</code>等操作。Babel通过<code>babel-traverse</code>对其进行<code>深度优先遍历</code>，维护AST树的整体状态，并且可完成对其的替换，删除或者增加节点，这个方法的参数为原始AST和自定义的转换规则，返回结果为转换后的AST。</p> <p><strong>生成</strong></p> <p>代码生成步骤把最终（经过一系列转换之后）的 <code>AST</code> 转换成字符串形式的代码，同时还会创建源码映射（source maps）(http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/)。.</p> <p>代码生成其实很简单：<code>深度优先遍历</code>整个 <code>AST</code>，然后构建可以<code>表示转换后</code>代码的<code>字符串</code>。</p> <p>Babel通过babel-generator再<code>转换成js代码</code>，过程就是深度优先遍历整个AST，然后构建出可以表示转换后代码的字符串。</p> <h2 id="_8-vue中ast抽象语法树的运用"><a href="#_8-vue中ast抽象语法树的运用" class="header-anchor">#</a> 8. vue中AST抽象语法树的运用;</h2> <p>vue中AST主要运用在模板编译过程.</p> <p>我们先来看看vue模板编译的整体流程图：</p> <p><a data-fancybox="" title="ast" href="/ast4.png"><img src="/ast4.png" alt="order"></a></p> <p><strong>vue模板编译</strong></p> <p>vue中的模板编译主要分为三个步骤:</p> <ul><li><p>解析器阶段: 将 <code>template</code> 里面的代码解析成<code>AST抽象语法树</code>;</p></li> <li><p>优化器阶段: 将<code>AST</code>抽象语法树<code>静态标签</code>打上<code>tag</code>,防止<code>重复渲染</code>(优化了diff算法);</p></li> <li><p>代码生成器阶段: 优化后的AST抽象语法树通过<code>generate</code>函数生成<code>render函数字符串</code>；</p></li></ul> <p><strong>我们来看看vue源码的整体实现过程:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>export const createCompiler = createCompilerCreator(function baseCompile (
  template: string,
  options: CompilerOptions
): CompiledResult {
  //生成ast的过程                                                 
  const ast = parse(template.trim(), options)
  //优化ast的过程,给ast抽象语法树静态标签打上tag,防止重复渲染
  if (options.optimize !== false) {
    optimize(ast, options)
  }
  //通过generate函数生成render函数字符串
  const code = generate(ast, options)
  return {
    ast,
    render: code.render,
    staticRenderFns: code.staticRenderFns
  }
})
</code></pre></div><p><code>解析器</code>要实现的功能就是将<code>模板</code>解析成<code>AST</code>，我们这里主要来分析一下代码解析阶段，这里主要运用的是<code>parse()</code>这个函数。</p> <p>事实上,<code>解析器内部</code>也分为好<code>几个</code>解析器,比如<code>HTML解析器</code>、<code>文本解析器</code>以及<code>过滤解析器</code>，其中最主要的就是HTML解析器。</p> <p>HTML解析器的作用就是解析HTML，它在解析HTML的过程中会不断触发各种<code>钩子函数</code>，我们来看看代码实现：</p> <div class="language- extra-class"><pre class="language-text"><code>parseHTML(template, { 
    //解析开始标签
    start (tag, attrs, unary, start, end) {
 
    },
    //解析结束标签
    end (tag, start, end) {
 
    },
    //解析文本
    chars (text: string, start: number, end: number) {
 
    },
    //解析注释
    comment (text: string, start, end){
 
    }
})
</code></pre></div><p>举个例子:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;div&gt;我们是大转转FE&lt;/div&gt;
</code></pre></div><p>当上面这个模板被HTML解析器解析时,所触发的钩子函数依次是: start、chars、end。</p> <p>所以HTML解析器在实现上是一个函数，它有两个参数----<code>模板和选项</code>，我们的模板是<code>一小段一小段</code>去截取与解析的，所以需要不断<code>循环截取</code>，我们来看看vue内部实现原理：</p> <div class="language- extra-class"><pre class="language-text"><code>function parseHTML (html, options) {
 while (html) {
    //判断父元素为正常标签的元素的逻辑
   if (!lastTag || !isPlainTextElement(lastTag)) {
     //vue中要判断是 文本、注释、条件注释、DOCTYPE、结束、开始标签
     //除了文本标签， 其他的都是以 &lt; 开头, 所以区分处理
     var textEnd = html.indexOf('&lt;');
        if (textEnd === 0) {
         //注释的处理逻辑
         if (comment.test(html)) {}
         //条件注释的处理逻辑
         if (conditionalComment.test(html)) {}
         //doctype的处理逻辑
         var doctypeMatch = html.match(doctype);
                if (doctypeMatch) {}
                //结束标签的处理逻辑
                var endTagMatch = html.match(endTag);
                if (endTagMatch) {}
                //开始标签的处理逻辑
                var startTagMatch = parseStartTag();
                if (startTagMatch) {}
        }
        
             var text = (void 0), rest = (void 0), next = (void 0);
             //解析文本
             if (textEnd &gt;= 0) {}
             // &quot;&lt;&quot; 字符在当前 html 字符串中不存在
             if (textEnd &lt; 0) {
                text = html
                html = ''
              }
              // 如果存在 text 文本
              // 调用 options.chars 回调，传入 text 文本
             if (options.chars &amp;&amp; text) {
               // 字符相关回调
               options.chars(text)
             }
   }else{
    // 父元素为script、style、textarea的处理逻辑
   }
 }
}
</code></pre></div><p>以上就是vue解析器生成AST语法树的主流程了，代码细节的地方还需要自己去解读源码，源码位置:\vue\packages\weex-template-compiler\build.js</p> <p><strong>结语：</strong>
AST抽象语法树的知识点作为JavaScript中(任何编程语言中都有ast这个概念,这里就不过多赘述)相对基础的，也是最不可忽略的知识，带给我们的启发是无限可能的；它就像一把螺丝刀，能够拆解javascript这台庞大的机器，让我们能够看到一些本质的东西，同时也能通过它批量构建任何javascript代码。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/longweixia/js/reg/text2.html" class="prev">
        手写函数(复杂)
      </a></span> <span class="next"><a href="/longweixia/js/arry.html">
        数组和对象
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/longweixia/assets/js/app.30853e2a.js" defer></script><script src="/longweixia/assets/js/2.19b4ab8a.js" defer></script><script src="/longweixia/assets/js/38.77987057.js" defer></script>
  </body>
</html>
